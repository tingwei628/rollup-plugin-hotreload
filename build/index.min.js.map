{"version":3,"file":"index.min.js","sources":["../lib/rollup-plugin-hotreload.js"],"sourcesContent":["import { randomBytes } from \"crypto\";\nimport {\n  readFile,\n  writeFile,\n  createReadStream,\n  createWriteStream\n} from \"fs\";\nimport { join } from \"path\";\nimport { Transform } from \"stream\";\nimport http from 'http';\n\nvar _hashkey = randomBytes(6).toString('hex');\nvar obj = { reqNow: null, hashKey: _hashkey, copyStr: null, isAppend: false };\nvar rphPath = \"/rollup-plugin-hotreload\";\nvar buildPaths = [];\nvar isCopyFilePathToHotreloadJs = false;\nvar rootDir = null;\nvar copyPaths = [];\nvar rphServer = http.createServer().listen(9999);\nexport function rph(options) {\n  if (!options.rootDir)\n    throw TypeError(\"rootDir is needed!\");\n\n  if (!Array.isArray(options.buildPaths))\n    throw SyntaxError(\"buildPaths must have at least ONE file\");\n\n  if (!options.templateHtmlPath)\n    throw SyntaxError(\"templatePath html is needed!\");\n\n  rootDir = options.rootDir;\n  buildPaths = options.buildPaths.slice();\n  var is_stop_rph = !!options.isStopRPH;\n\n  for (let index = 0; index < buildPaths.length; index++) {\n    let element = buildPaths[index];\n    if (!element[0] && !element[1]) {\n      throw TypeError(\"both the first: build file path and \\\n    the second: source path are needed!\");\n    }\n    copyPaths = copyPaths.concat(`\"${element[0]}\"`);\n  }\n  obj.copyStr = copyPaths.join(\",\");\n\n  function sockethandlerTEST() {\n    if (is_stop_rph)\n      return;\n    this.hashKey = randomBytes(6).toString('hex');\n    if (rphServer) {\n      rphServer.on('request', function (inReq, inRes) {\n        if (inReq.url === rphPath && !inRes.finished) {\n          this.reqNow = inReq;\n          // set Header before write\n          inRes.writeHead(200, {\n            'Content-Type': 'text/event-stream',\n            'Cache-Control': 'no-cache',\n            'Connection': 'keep-alive',\n            'Access-Control-Allow-Origin': '*'\n          });\n          inRes.write(\"data: \" + this.hashKey + \"\\n\\n\");\n          inRes.end();\n        }\n      }.bind(this));\n    }\n    if (this.reqNow !== null) {\n      this.reqNow.on('close', function () {\n        console.warn(\"close isReload\");\n      });\n    }\n  }\n  return {\n    name: \"rollup-plugin-hotreload\",\n    ongenerate: sockethandlerTEST.bind(obj),\n    onwrite: function (opts) {\n      // ONLY ONCE\n      if (!isCopyFilePathToHotreloadJs) {\n        console.log('isCopyFilePathToHotreloadJs-> ', isCopyFilePathToHotreloadJs);\n        // read hotreload.js and inject loaded js\n        // rootDir = build/\n        // copy ./hotreload.min.js to rootDir/hotreload.min.js\n        // NOTE: hotreload.js in the same directory as rootDir\n        var rs = createReadStream(join(__dirname, \"hotreload.min.js\"));\n        rs.pipe(copyTransform)\n          .pipe(createWriteStream(rootDir + \"/hotreload.min.js\"));\n\n        isCopyFilePathToHotreloadJs = true;\n      }\n\n      readFile(join(__dirname, options.templateHtmlPath), \"utf8\", function (err, htmlString) {\n        if (err) throw err;\n        /*\n          Inspired by rollup-plugin-generate-html-template@bengsfort\n          How to append js in html\n        */\n        var newHtmlString = [\n          htmlString.slice(0, htmlString.indexOf(\"</body>\")),\n          `<script type=\"text/javascript\" src=\"hotreload.min.js\"></script>\\n`,\n          htmlString.slice(htmlString.indexOf(\"</body>\"), htmlString.length)\n        ].join(\"\");\n        writeFile(`./${rootDir}/index.html`, newHtmlString, function (err) {\n          if (err) throw err;\n        });\n      });\n    }\n  };\n}\nconst copyTransform = new Transform({\n  transform(chunk, encoding, callback) {\n    if (!obj.isAppend && obj.copyStr !== null) {\n      this.push(`var loadfilePath = [${obj.copyStr}];\\n`);\n      obj.isAppend = true;\n    }\n    this.push(chunk);\n  }\n});\n\nfunction bundle(config, dirname, outputpath, sourcefilepath) {\n  const buildModule = { module: null, outputPath: null };\n  const output1 = Object.assign({}, config.output, {\n    file: outputpath,\n  });\n  const module1 = Object.assign({}, config, {\n    input: join(dirname, sourcefilepath),\n    output: output1,\n  });\n  buildModule.module = module1;\n  buildModule.outputPath = outputpath;\n  return buildModule;\n}\n\nfunction multibundles(config, dirname) {\n  if (!Array.isArray) {\n    throw SyntaxError(\"Array.isArray is not supported!\");\n  }\n  let buildArr = [];\n  for (let index = 0; index < buildPaths.length; index++) {\n    let element = buildPaths[index];\n    if (!element[0] && !element[1]) {\n      throw TypeError(\"both the first: build file path and \\\n      the second: source path are needed!\");\n    }\n    buildArr = buildArr.concat(bundle(config, dirname, join(rootDir, element[0]), element[1]).module);\n  }\n  return buildArr;\n}\n\nexport {\n  multibundles as rphMultibundles\n};"],"names":["_hashkey","randomBytes","toString","obj","reqNow","hashKey","copyStr","isAppend","rphPath","buildPaths","isCopyFilePathToHotreloadJs","rootDir","copyPaths","rphServer","http","createServer","listen","rph","options","TypeError","Array","isArray","SyntaxError","templateHtmlPath","slice","is_stop_rph","isStopRPH","index","length","element","concat","join","sockethandlerTEST","on","inReq","inRes","url","finished","writeHead","write","end","bind","warn","opts","log","rs","createReadStream","__dirname","pipe","copyTransform","createWriteStream","err","htmlString","newHtmlString","indexOf","Transform","chunk","encoding","callback","push","bundle","config","dirname","outputpath","sourcefilepath","buildModule","module","outputPath","output1","Object","assign","output","module1","multibundles","buildArr"],"mappings":"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"}