{"version":3,"file":"index.min.js","sources":["../lib/rollup-plugin-hotreload.js"],"sourcesContent":["import { randomBytes } from \"crypto\";\nimport {\n  readFile,\n  writeFile,\n  createReadStream,\n  createWriteStream\n} from \"fs\";\nimport { join } from \"path\";\nimport { Transform } from \"stream\";\n\nvar _hashkey = randomBytes(6).toString('hex');\nvar obj = { reqNow: null, hashKey: _hashkey, copyStr: null, isAppend: false };\nvar rphPath = \"/rollup-plugin-hotreload\";\nvar buildPaths = [];\nvar isCopyFilePathToHotreloadJs = false;\nvar rootDir = null;\nvar copyPaths = [];\nexport function rph(options) {\n  if (!options.rootDir)\n    throw TypeError(\"rootDir is needed!\");\n\n  if (!Array.isArray(options.buildPaths))\n    throw SyntaxError(\"buildPaths must have at least ONE file\");\n\n  if (!options.server)\n    throw SyntaxError(\"Server is needed!\");\n\n  if (!options.templateHtmlPath)\n    throw SyntaxError(\"templatePath html is needed!\");\n\n  rootDir = options.rootDir;\n  buildPaths = options.buildPaths.slice();\n  var is_stop_rph = !!options.isStopRPH;\n  var server = options.server;\n\n  for (let index = 0; index < buildPaths.length; index++) {\n    let element = buildPaths[index];\n    if (!element[0] && !element[1]) {\n      throw TypeError(\"both the first: build file path and \\\n    the second: source path are needed!\");\n    }\n    copyPaths = copyPaths.concat(`\"${element[0]}\"`);\n  }\n  obj.copyStr = copyPaths.join(\",\");\n\n  function sockethandlerTEST() {\n    if (is_stop_rph)\n      return;\n    this.hashKey = randomBytes(6).toString('hex');\n    server.on(\"request\", function (req, res) {\n      if (req.url === rphPath) {\n        this.reqNow = req;\n        res.writeHead(200, {\n          'Content-Type': 'text/event-stream',\n          'Cache-Control': 'no-cache',\n          'Connection': 'keep-alive'\n        });\n        res.write(\"data: \" + this.hashKey + \"\\n\\n\");\n      }\n    }.bind(this));\n\n    if (this.reqNow !== null) {\n      this.reqNow.on('close', function () {\n        console.warn(\"close isReload\");\n      });\n    }\n  }\n  return {\n    name: \"rollup-plugin-hotreload\",\n    ongenerate: sockethandlerTEST.bind(obj),\n    onwrite: function (opts) {\n      // ONLY ONCE\n      if (!isCopyFilePathToHotreloadJs) {\n\n        // read hotreload.js and inject loaded js\n        // rootDir = build/\n        // copy ./hotreload.js to ./build/js/hotreload.js\n        // NOTE: hotreload.js in the same directory as rootDir\n        createReadStream(join(__dirname, \"./plugins/hotreload.js\"))\n          .pipe(copyTransform)\n          .pipe(createWriteStream(join(__dirname, `./${rootDir}/hotreload.js`)));\n\n        isCopyFilePathToHotreloadJs = true;\n      }\n\n      readFile(join(__dirname, options.templateHtmlPath), \"utf8\", function (err, htmlString) {\n        if (err) throw err;\n        /*\n          Inspired by rollup-plugin-generate-html-template@bengsfort\n          How to append js in html\n        */\n        var newHtmlString = [\n          htmlString.slice(0, htmlString.indexOf(\"</body>\")),\n          `<script type=\"text/javascript\" src=\"/hotreload.js\"></script>\\n`,\n          htmlString.slice(htmlString.indexOf(\"</body>\"), htmlString.length)\n        ].join(\"\");\n        writeFile(join(__dirname, `./${rootDir}/index.html`), newHtmlString, function (err) {\n          if (err) throw err;\n        });\n      });\n    }\n  };\n}\nconst copyTransform = new Transform({\n  transform(chunk, encoding, callback) {\n    if (!obj.isAppend && obj.copyStr !== null) {\n      this.push(`var loadfilePath = [${obj.copyStr}];\\n`);\n      obj.isAppend = true;\n    }\n    this.push(chunk);\n  }\n});\n\nfunction bundle(config, dirname, outputpath, sourcefilepath) {\n  const buildModule = { module: null, outputPath: null };\n  const output1 = Object.assign({}, config.output, {\n    file: join(dirname, outputpath)\n  });\n  const module1 = Object.assign({}, config, {\n    input: join(dirname, sourcefilepath),\n    output: output1,\n  });\n  buildModule.module = module1;\n  buildModule.outputPath = outputpath;\n  return buildModule;\n}\n\nfunction multibundles(config, dirname) {\n  if (!Array.isArray) {\n    throw SyntaxError(\"Array.isArray is not supported!\");\n  }\n  let buildArr = [];\n  for (let index = 0; index < buildPaths.length; index++) {\n    let element = buildPaths[index];\n    if (!element[0] && !element[1]) {\n      throw TypeError(\"both the first: build file path and \\\n      the second: source path are needed!\");\n    }\n    buildArr = buildArr.concat(bundle(config, dirname, join(rootDir, element[0]), element[1]).module);\n  }\n  return buildArr;\n}\n\nexport {\n  multibundles as rphMultibundles\n};"],"names":["_hashkey","randomBytes","toString","obj","reqNow","hashKey","copyStr","isAppend","rphPath","buildPaths","isCopyFilePathToHotreloadJs","rootDir","copyPaths","rph","options","TypeError","Array","isArray","SyntaxError","server","templateHtmlPath","slice","is_stop_rph","isStopRPH","index","length","element","concat","join","sockethandlerTEST","on","req","res","url","writeHead","write","bind","warn","opts","__dirname","pipe","copyTransform","createWriteStream","err","htmlString","newHtmlString","indexOf","Transform","chunk","encoding","callback","push","bundle","config","dirname","outputpath","sourcefilepath","buildModule","module","outputPath","output1","Object","assign","output","module1","multibundles","buildArr"],"mappings":"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"}