{"version":3,"file":"index.min.js","sources":["../lib/rollup-plugin-hotreload.js"],"sourcesContent":["import { randomBytes } from \"crypto\";\nimport {\n  readFile,\n  writeFile,\n  createReadStream,\n  createWriteStream\n} from \"fs\";\nimport { join } from \"path\";\nimport { Transform } from \"stream\";\nimport http from 'http';\n\nvar _hashkey = randomBytes(6).toString('hex');\nvar obj = { reqNow: null, hashKey: _hashkey, copyStr: null, isAppend: false };\nvar rphPath = \"/rollup-plugin-hotreload\";\nvar buildPaths = [];\nvar isCopyFilePathToHotreloadJs = false;\nvar rootDir = null;\nvar copyPaths = [];\nvar rphServer = http.createServer().listen(9999);\nexport function rph(options) {\n  if (!options.rootDir)\n    throw TypeError(\"rootDir is needed!\");\n\n  if (!Array.isArray(options.buildPaths))\n    throw SyntaxError(\"buildPaths must have at least ONE file\");\n\n  if (!options.templateHtmlPath)\n    throw SyntaxError(\"templatePath html is needed!\");\n\n  rootDir = options.rootDir;\n  buildPaths = options.buildPaths.slice();\n  var is_stop_rph = !!options.isStopRPH;\n\n  for (let index = 0; index < buildPaths.length; index++) {\n    let element = buildPaths[index];\n    if (!element[0] && !element[1]) {\n      throw TypeError(\"both the first: build file path and \\\n    the second: source path are needed!\");\n    }\n    copyPaths = copyPaths.concat(`\"${element[0]}\"`);\n  }\n  obj.copyStr = copyPaths.join(\",\");\n\n  function sockethandlerTEST() {\n    if (is_stop_rph)\n      return;\n    this.hashKey = randomBytes(6).toString('hex');\n    if (rphServer) {\n      rphServer.on('request', function (inReq, inRes) {\n        if (inReq.url === rphPath && !inRes.finished) {\n          this.reqNow = inReq;\n          // set Header before write\n          inRes.writeHead(200, {\n            'Content-Type': 'text/event-stream',\n            'Cache-Control': 'no-cache',\n            'Connection': 'keep-alive',\n            'Access-Control-Allow-Origin': '*'\n          });\n          inRes.write(\"data: \" + this.hashKey + \"\\n\\n\");\n          inRes.end();\n        }\n      }.bind(this));\n    }\n    if (this.reqNow !== null) {\n      this.reqNow.on('close', function () {\n        console.warn(\"close isReload\");\n      });\n    }\n  }\n  return {\n    name: \"rollup-plugin-hotreload\",\n    ongenerate: sockethandlerTEST.bind(obj),\n    onwrite: function (opts) {\n      // ONLY ONCE\n      if (!isCopyFilePathToHotreloadJs) {\n        console.log('isCopyFilePathToHotreloadJs-> ', isCopyFilePathToHotreloadJs);\n        // read hotreload.js and inject loaded js\n        // rootDir = build/\n        // copy ./hotreload.min.js to rootDir/hotreload.min.js\n        // NOTE: hotreload.js in the same directory as rootDir\n        var rs = createReadStream(join(__dirname, \"hotreload.min.js\"));\n        rs.pipe(copyTransform)\n          .pipe(createWriteStream(rootDir + \"/hotreload.min.js\"));\n\n        isCopyFilePathToHotreloadJs = true;\n      }\n\n      readFile(options.templateHtmlPath, \"utf8\", function (err, htmlString) {\n        if (err) throw err;\n        /*\n          Inspired by rollup-plugin-generate-html-template@bengsfort\n          How to append js in html\n        */\n        var newHtmlString = [\n          htmlString.slice(0, htmlString.indexOf(\"</body>\")),\n          `<script type=\"text/javascript\" src=\"hotreload.min.js\"></script>\\n`,\n          htmlString.slice(htmlString.indexOf(\"</body>\"), htmlString.length)\n        ].join(\"\");\n        writeFile(`${rootDir}/index.html`, newHtmlString, function (err) {\n          if (err) throw err;\n        });\n      });\n    }\n  };\n}\nconst copyTransform = new Transform({\n  transform(chunk, encoding, callback) {\n    if (!obj.isAppend && obj.copyStr !== null) {\n      this.push(`var loadfilePath = [${obj.copyStr}];\\n`);\n      obj.isAppend = true;\n    }\n    this.push(chunk);\n  }\n});\n\nfunction bundle(config, dirname, outputpath, sourcefilepath) {\n  const buildModule = { module: null, outputPath: null };\n  const output1 = Object.assign({}, config.output, {\n    file: outputpath,\n  });\n  const module1 = Object.assign({}, config, {\n    input: join(dirname, sourcefilepath),\n    output: output1,\n  });\n  buildModule.module = module1;\n  buildModule.outputPath = outputpath;\n  return buildModule;\n}\n\nfunction multibundles(config, dirname) {\n  if (!Array.isArray) {\n    throw SyntaxError(\"Array.isArray is not supported!\");\n  }\n  let buildArr = [];\n  for (let index = 0; index < buildPaths.length; index++) {\n    let element = buildPaths[index];\n    if (!element[0] && !element[1]) {\n      throw TypeError(\"both the first: build file path and \\\n      the second: source path are needed!\");\n    }\n    buildArr = buildArr.concat(bundle(config, dirname, join(rootDir, element[0]), element[1]).module);\n  }\n  return buildArr;\n}\n\nexport {\n  multibundles as rphMultibundles\n};"],"names":["obj","reqNow","hashKey","randomBytes","toString","copyStr","isAppend","buildPaths","isCopyFilePathToHotreloadJs","rootDir","copyPaths","rphServer","http","createServer","listen","copyTransform","Transform","chunk","encoding","callback","push","options","TypeError","Array","isArray","SyntaxError","templateHtmlPath","slice","is_stop_rph","isStopRPH","index","length","element","concat","join","on","inReq","inRes","url","finished","writeHead","write","this","end","bind","warn","opts","log","createReadStream","__dirname","pipe","createWriteStream","err","htmlString","newHtmlString","indexOf","config","dirname","outputpath","sourcefilepath","buildModule","output1","module1","buildArr","module","outputPath","Object","assign","output"],"mappings":"gaAWA,IACIA,EAAM,CAAEC,OAAQ,KAAMC,QADXC,cAAY,GAAGC,SAAS,OACMC,QAAS,KAAMC,UAAU,GAElEC,EAAa,GACbC,GAA8B,EAC9BC,EAAU,KACVC,EAAY,GACZC,EAAYC,EAAKC,eAAeC,OAAO,MAuF3C,IAAMC,EAAgB,IAAIC,YAAU,oBACxBC,EAAOC,EAAUC,GACpBnB,EAAIM,UAA4B,OAAhBN,EAAIK,eAClBe,4BAA4BpB,EAAIK,kBACjCC,UAAW,QAEZc,KAAKH,YA5Fd,SAAoBI,OACbA,EAAQZ,QACX,MAAMa,UAAU,0BAEbC,MAAMC,QAAQH,EAAQd,YACzB,MAAMkB,YAAY,8CAEfJ,EAAQK,iBACX,MAAMD,YAAY,kCAEVJ,EAAQZ,UACLY,EAAQd,WAAWoB,gBAC5BC,IAAgBP,EAAQQ,UAEnBC,EAAQ,EAAGA,EAAQvB,EAAWwB,OAAQD,IAAS,KAClDE,EAAUzB,EAAWuB,OACpBE,EAAQ,KAAOA,EAAQ,SACpBV,UAAU,iFAGNZ,EAAUuB,WAAWD,EAAQ,iBAEvC3B,QAAUK,EAAUwB,KAAK,KA4BtB,MACC,gDA1BFN,SAEC1B,QAAUC,cAAY,GAAGC,SAAS,OACnCO,KACQwB,GAAG,UAAW,SAAUC,EAAOC,GAnCjC,6BAoCFD,EAAME,KAAoBD,EAAME,gBAC7BtC,OAASmC,IAERI,UAAU,IAAK,gBACH,oCACC,sBACH,2CACiB,QAE3BC,MAAM,SAAWC,KAAKxC,QAAU,UAChCyC,QAERC,KAAKF,OAEW,OAAhBA,KAAKzC,aACFA,OAAOkC,GAAG,QAAS,mBACdU,KAAK,sBAMaD,KAAK5C,WAC1B,SAAU8C,GAEZtC,YACKuC,IAAI,iCAAkCvC,GAKrCwC,mBAAiBd,OAAKe,UAAW,qBACvCC,KAAKnC,GACLmC,KAAKC,oBAAkB1C,EAAU,yBAEN,cAGvBY,EAAQK,iBAAkB,OAAQ,SAAU0B,EAAKC,MACpDD,EAAK,MAAMA,MAKXE,EAAgB,CAClBD,EAAW1B,MAAM,EAAG0B,EAAWE,QAAQ,iFAEvCF,EAAW1B,MAAM0B,EAAWE,QAAQ,WAAYF,EAAWtB,SAC3DG,KAAK,gBACMzB,gBAAsB6C,EAAe,SAAUF,MACtDA,EAAK,MAAMA,2BA8BzB,SAAsBI,EAAQC,OACvBlC,MAAMC,cACHC,YAAY,2CAhBN+B,EAAQC,EAASC,EAAYC,EACrCC,EACAC,EAGAC,EAaFC,EAAW,GACNjC,EAAQ,EAAGA,EAAQvB,EAAWwB,OAAQD,IAAS,KAClDE,EAAUzB,EAAWuB,OACpBE,EAAQ,KAAOA,EAAQ,SACpBV,UAAU,mFAGPyC,EAAS9B,QAzBRuB,EAyBsBA,EAzBdC,EAyBsBA,EAzBbC,EAyBsBxB,OAAKzB,EAASuB,EAAQ,IAzBhC2B,EAyBqC3B,EAAQ,GAxBlF4B,OAAAA,EAAAA,EAAc,CAAEI,OAAQ,KAAMC,WAAY,MAC1CJ,EAAUK,OAAOC,OAAO,GAAIX,EAAOY,OAAQ,MACzCV,IAEFI,EAAUI,OAAOC,OAAO,GAAIX,EAAQ,OACjCtB,OAAKuB,EAASE,UACbE,MAEEG,OAASF,IACTG,WAAaP,EAClBE,GAcqFI,eAErFD"}